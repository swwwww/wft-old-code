//no move
function noMove(e){e.preventDefault();}
(function() {
    "use strict";
    var docBody = document.body,
        ua = navigator.userAgent.toLowerCase(),
        touchStart = "touchstart",
        touchMove = "touchmove",
        touchEnd = "touchend",
        clickEvent = "touchend";

    if(!ua.match("mobile")){
        touchStart = "mousedown";
        touchMove = "mousemove";
        touchEnd = "mouseup";
        clickEvent = "click";
    }

    var select_box = $("#select-box"),
        select_ul = $("#select-ul"),
        select = $("#select");
    select_ul.hide();
    select.on(clickEvent,function() {
        $(this).parent().find("#select-ul").show();

    });

    select_ul.on(clickEvent,function(e) {
        if(e.target){
            select.get(0).innerText = e.target.innerText;
            select_ul.hide();
            select.focus();
        }
    },false);

    //win
    var win = new function(){
        var obj = document.getElementById("check-win"),
            box = document.getElementById("check-win-box"),
            list = document.getElementsByClassName("check-win-list"),
            win_tip = document.getElementsByClassName("check-win-tips")[0],
            win_send = document.getElementsByClassName("check-win-send");

        var timeout;
        var defaultFun = function(){
            obj.style.background = "rgba(0,0,0,0)";
            box.style.cssText = "-webkit-transform:translate(-50%,-50%) scale(0.4);transform:translate(-50%,-50%) scale(0.4);opacity:0;";
            timeout = setTimeout(function(){
                obj.style.display = "none";
                docBody.removeEventListener("touchmove",noMove,false);
            },400);
        };

        /**
         win.show("send");//二维码
         win.show("text");//错误提示
         */
        this.show = function(type,text){
            clearTimeout(timeout);
            var text = text || "";
            for(var k=0;k<list.length;k++){
                list[k].style.display = "none";
            }
            docBody.addEventListener("touchmove",noMove,false);
            switch(type){
                case "text":
                    win_tip.style.display = "block";
                    break;
                case "send":
                    for(var l=0;l<win_send.length;l++){
                        win_send[l].style.display = "block";
                    }
                    break;
            }
            obj.style.display = "block";
            timeout = setTimeout(function(){
                obj.style.background = "rgba(0,0,0,0.8)";
                box.style.cssText = "-webkit-transform:translate(-50%,-50%) scale(1);transform:translate(-50%,-50%) scale(1);opacity:1;";
            },100);
        };

        //hide
        this.hide = defaultFun;

        box.addEventListener(clickEvent,function(e) {
            if(e.target && e.target.classList.contains('check-win-close')){
                win.hide();
            }
        },false)
    };

    //form 验证码
    var codeAble = true,
        code = document.getElementById("code"),
        checkCode = document.getElementById("check-code"),
        codeTip = document.getElementById("codeTip"),
        goodName = document.getElementById("good_name"),
        goodPrice = document.getElementById("good_price"),
        series = document.getElementById("series"),
        orderSn = document.getElementById("order_sn"),
        buyName = document.getElementById("buy_name"),
        useAddr = document.getElementById("use_addr"),
        checkSend = document.getElementById("sending"),
        checkSet = document.getElementById('uncheck'),
        checkinfo = document.getElementById('check_info'),
        checkedSet = document.getElementById('checked'),
        codeMark = document.getElementById("code-mark");
    if(checkCode != undefined) {
        checkCode.addEventListener(clickEvent,function(){
            var codeValue = code.value;
            //    self = $(this),
            //    urlJson = self.data('code');
            //console.log(urlJson);
            if(codeValue == ""){
                codeTip.getElementsByTagName("i")[0].innerHTML = "您还未输入验证码";
                win.show("text");
                return false;
            }

            var url = '/seller/index/code'; //请求URL

            $.post("/seller/index/code",{'code':codeValue},function(data){
                if(data.status==1){
                    codeMark.innerHTML = codeValue;
                    goodName.innerHTML = data.data.coupon_name;
                    goodPrice.innerHTML = data.data.coupon_unit_price;
                    series.innerHTML = data.data.price_name;
                    orderSn.innerHTML = data.data.order_sn;
                    buyName.innerHTML = data.data.phone;
                    useAddr.innerHTML = data.data.address;
                    checkedSet.style.display='none';
                    win.show("send");
                }else if(data.status==2){
                    codeMark.innerHTML = codeValue;
                    goodName.innerHTML = data.data.coupon_name;
                    goodPrice.innerHTML = data.data.coupon_unit_price;
                    series.innerHTML = data.data.price_name;
                    orderSn.innerHTML = data.data.order_sn;
                    buyName.innerHTML = data.data.phone;
                    useAddr.innerHTML = data.data.address;
                    checkinfo.innerHTML = data.message;
                    checkSet.style.display='none';
                    win.show('send');
                }else{
                    codeTip.getElementsByTagName("i")[0].innerHTML = data.message;
                    win.show("text");
                    return false;
                    codeAble = true;
                }
            },'json');
        },false);
    }
    function codeForm(){
        if(!codeAble){ return false; }
        codeAble = false;
        var codeValue = code.value;
        var shop_id = document.getElementById("shop_id");
        var sid = shop_id.value;
        console.log(codeValue);
        //ajax
        var url = '/seller/index/validate'; //请求URL
        $.post("/seller/index/validate",{'code':codeValue,'shop_id':sid},function(data){
            if(data.status==1){
                alert(data.message);
                window.location.reload();
            }else{
                codeTip.getElementsByTagName("i")[0].innerHTML = "验证失败";
                win.show("text");
                return false;
                codeAble = true;
            }
        },'json');
    }
    if(checkSend != undefined){
        checkSend.addEventListener(clickEvent,codeForm,false);
    }

    //form 登录
    var phone = document.getElementById("phone"),
        password = document.getElementById("password"),
        type = document.getElementById("checkbox"),
        submitBtn = document.getElementById("submitBtn"),
        phoneReg = /^1(3|4|5|7|8)\d{9}$/,
        submitAble = true,
        loginTip = document.getElementById("loginTip");

    //function inRight(){
    //    $("input").get(0).("in-right");
    //}

    function check_tel () {
        var phoneValue = phone.value.trim();
        if(phoneValue == ""){
            loginTip.getElementsByTagName("i")[0].innerHTML = "您还未输入手机号码哦";
            win.show("text");
            phone.focus();
            return false;
        }

        //if(!phoneReg.test(phoneValue)){
        //    loginTip.getElementsByTagName("i")[0].innerHTML = "您输入的手机号码有误";
        //    win.show("text");
        //    return false;
        //} else{
        //    //console.log(phoneValue);
        //}
        return true;
    }

    //form tip
    function submitForm(){
        if(!submitAble){ return false; }
        if(!check_tel()) {return ;}

        var passwordValue = password.value.trim();
        var phoneValue = phone.value.trim();
        var typeValue = type.checked;

        if(passwordValue == ""){
            loginTip.getElementsByTagName("i")[0].innerHTML = "您还未输入密码哦";
            win.show("text");
            password.focus();
            return false;
        }
        submitAble = false;
        submitBtn.value = "登录中...";
        //ajax

        $.post("/seller/index/login", {'mobile':phoneValue,'password':passwordValue,'type':typeValue}, function (data){
            if(data.status == 1){
                window.location.href = "/seller/index/code";
            }else if (data.status == 0) {
                alert(data.message)
                window.location.reload();
            }else if(data.status==2){
                var ask=confirm("你还未绑定手机号，现在就去绑定？");
                if(ask==true){
                    window.location.href="/seller/index/bind";
                }else{
                    window.location.href = "/seller/index/code";
                }
            }
        },"json");
    }
    if(submitBtn != undefined){
        submitBtn.addEventListener(clickEvent,submitForm,false);
    }

    var changeBtn = document.getElementById("changeBtn"),
        user = document.getElementById("user"),
        pwdNew = document.getElementById("new_pwd"),
        pwdOld = document.getElementById("pwd"),
        pwdNewR = document.getElementById("re_pwd"),
        changeAble = true;

    //change form
    function changeForm(){
        if(!changeAble){ return false; }
        var userValue = user.value.trim(),
            passwordValue = pwdOld.value.trim(),
            pwdNewValue = pwdNew.value.trim(),
            pwdNewRValue = pwdNewR.value.trim();
        if(userValue == ""){
            loginTip.getElementsByTagName("i")[0].innerHTML = "您还未输入用户名/ID哦";
            win.show("text");
            user.focus();
            return false;
        }

        if(passwordValue == ""){
            loginTip.getElementsByTagName("i")[0].innerHTML = "您还未输入密码哦";
            win.show("text");
            pwdOld.focus();
            return false;
        }

        if(!(pwdNewValue === pwdNewRValue)){
            loginTip.getElementsByTagName("i")[0].innerHTML = "您两次输入的新密码不一致！";
            win.show("text");
            return false;
        }

        changeAble = false;
        changeBtn.value = "提交中...";

        //ajax
        var url = '/seller/index/change'; //请求URL
        $.ajax({
            type:"POST",
            dataType:"json",
            url:url,
            data:{'new_pwd':pwdNewValue,'name':userValue,'pwd':passwordValue},
            success:function(data){
                //console.log(data);
                alert(data.message);
                window.location.href = "/seller/index/login";
            },
            error: function(){
                changeBtn.value = "提交失败";
                changeAble = true;
            }
        });

    }

    if(changeBtn != undefined){
        changeBtn.addEventListener(clickEvent,changeForm,false);
    }


    //forgetForm
    var forgetBtn = document.getElementById("forgetBtn"),
        user = document.getElementById("user"),
        pwdNew = document.getElementById("new_pwd"),
        phone = document.getElementById("phone"),
        code = document.getElementById("code"),
        getVcodeBtn = document.getElementById("get_vcode_btn"),
        forgetAble = true,
        flag = 1,
        InterValObj,  //timer变量，控制时间
        count = 60,  //间隔函数，1秒执行
        curCount;  //当前剩余秒数

    //获取验证码
    function setVCodeBtn(){
        getVcodeBtn.value = "" + curCount + "s";
        InterValObj = window.setInterval(SetRemainTime, 1000); //启动计时器，1秒执行一次
        getVcodeBtn.classList.add('gray_bg');
    }

    function SetRemainTime() {
        curCount--;
        if (curCount == 0) {
            flag = 1;
            window.clearInterval(InterValObj);//停止计时器
            getVcodeBtn.style.cssText = "pointer-events:auto";
            getVcodeBtn.value = "重新获取";
            getVcodeBtn.classList.remove('gray_bg');

        }
        else {
            getVcodeBtn.value = "" + curCount+"s" ;
        }
    }

    if(getVcodeBtn != undefined){
        getVcodeBtn.addEventListener(clickEvent,function(){
            if(!check_tel()) {return ;}
            var phoneValue = phone.value.trim(),
                userValue = user.value.trim();
            //getVcodeBtn.style.cssText = "pointer-events: none";
            var submit_data = {'phone':phoneValue,'user':userValue};
            curCount = count;
            //post 请求验证码
            $.post("/seller/index/sendCode", submit_data, function (data){
                if(data.response_params.status == 1){
                    setVCodeBtn();
                }else if (data.response_params.status == 0) {
                    alert(data.response_params.message)
                    $(getVcodeBtn).css({"pointer-events":'auto'});
                }
            },"json");
        },false);
    }

    function forgetForm(){
        if(!forgetAble){ return false; }
        var userValue = user.value.trim(),
            passwordValue = pwdNew.value.trim(),
            phoneValue = phone.value.trim(),
            codeValue = code.value.trim();
        if(userValue == ""){
            loginTip.getElementsByTagName("i")[0].innerHTML = "您还未输入用户名/ID哦";
            win.show("text");
            user.focus();
            return false;
        }

        if(!check_tel()) {return ;}

        if(codeValue == ""){
            loginTip.getElementsByTagName("i")[0].innerHTML = "您还未输入验证码哦";
            win.show("text");
            code.focus();
            return false;
        }

        if(passwordValue == ""){
            loginTip.getElementsByTagName("i")[0].innerHTML = "您还未输入新密码哦";
            win.show("text");
            pwdNew.focus();
            return false;
        }


        forgetAble = false;
        forgetAble.value = "提交中...";

        //ajax
        var url = '/seller/index/forget'; //请求URL
        $.ajax({
            type:"POST",
            dataType:"json",
            url:url,
            data:{'new_pwd':passwordValue,'name':userValue,'phone':phoneValue,'code':codeValue},
            success:function(data){
                //console.log(data);
                alert(data.message);
                //window.location.href = "/seller/index/login";
            },
            error: function(){
                changeBtn.value = "提交失败";
                changeAble = true;
            }
        });
    }

    if(forgetBtn != undefined){
        forgetBtn.addEventListener(clickEvent,forgetForm,false);
    }

    //bind form
    var bindBtn = document.getElementById("bindBtn"),
        user = document.getElementById("user"),
        phone = document.getElementById("phone"),
        pwd = document.getElementById("new_pwd"),
        code = document.getElementById("code"),
        getVcode = document.getElementById("get_vcode"),
        bindAble = true,
        flag = 1,
        InterValObj,  //timer变量，控制时间
        count = 60,  //间隔函数，1秒执行
        curCount;  //当前剩余秒数

    //获取验证码
    function setVCodeBtn(){
        getVcode.value = "" + curCount + "s";
        InterValObj = window.setInterval(SetRemainTime, 1000); //启动计时器，1秒执行一次
        getVcode.classList.add('gray_bg');
    }

    function SetRemainTime() {
        curCount--;
        if (curCount == 0) {
            flag = 1;
            window.clearInterval(InterValObj);//停止计时器
            getVcode.style.cssText = "pointer-events:auto";
            getVcode.value = "重新获取";
            getVcode.classList.remove('gray_bg');

        }
        else {
            getVcode.value = "" + curCount+"s" ;
        }
    }

    if(getVcode != undefined){
        getVcode.addEventListener(clickEvent,function(){
            if(!check_tel()) {return false;}
            var phoneValue = phone.value.trim(),
                userValue = user.value.trim();
            getVcode.style.cssText = "pointer-events: none";
            var submit_data = {'phone':phoneValue,'user':userValue};
            curCount = count;
            //post 请求验证码
            $.post("/seller/index/sendCode", submit_data, function (data){
                if(data.response_params.status == 1){
                    setVCodeBtn();
                }else if (data.response_params.status == 0) {
                    alert(data.response_params.message)
                    $(getVcode).css({"pointer-events":'auto'});
                }
            },"json");
        },false);
    }

    function bindForm(){
        if(!bindAble){ return false; }
        var userValue = user.value.trim(),
            phoneValue = phone.value.trim(),
            codeValue = code.value.trim(),
            pwdValue = pwd.value.trim();
        if(!check_tel()) {return ;}

        if(codeValue == ""){
            loginTip.getElementsByTagName("i")[0].innerHTML = "您还未输入验证码哦";
            win.show("text");
            code.focus();
            return false;
        }

        bindAble = false;
        bindBtn.value = "提交中...";

        //ajax
        var url = '/seller/index/bind'; //请求URL
        $.ajax({
            type:"POST",
            dataType:"json",
            url:url,
            data:{'phone':phoneValue,'code':codeValue,'pwd':pwdValue},
            success:function(data){
                if(data.status==1){
                    alert(data.message);
                    window.location.reload();
                }
                if(data.status=0){
                    alert(data.message);
                    window.location.reload();
                }
            },
            error: function(){
                bindBtn.value = "提交失败";
                bindAble = true;
            }
        });
    }

    if(bindBtn != undefined){
        bindBtn.addEventListener(clickEvent,bindForm,false);
    }

}());